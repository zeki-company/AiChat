package com.cdsy.aichat.ui.mainimport android.app.Applicationimport androidx.lifecycle.MutableLiveDataimport com.cdsy.aichat.manager.api.FinanceServiceimport com.cdsy.aichat.manager.sharedpref.SharedPrefModelimport com.cdsy.aichat.ui.base.BaseViewModelimport com.cdsy.aichat.ui.base.Eventimport com.cdsy.aichat.ui.base.LiveEventimport com.cdsy.aichat.util.switchThreadimport io.reactivex.Observableimport io.reactivex.Singleimport org.kodein.di.generic.instanceimport timber.log.Timberimport java.util.concurrent.TimeUnitimport kotlin.math.absoluteValue/** * @Author: ZEKI https://github.com/ZYF99 * @Date: 2021/7/27 4:03 下午 */class MainViewModel(application: Application) : BaseViewModel(application) {    private val financeService by instance<FinanceService>()    //private val apiService by instance<ApiService>()    val appBarOffsetBias = MutableLiveData(0F)    val modifyRecordEvent = LiveEvent<Event<Boolean>>()    val modifyPersonEvent = LiveEvent<Event<Boolean>>()    //val latestVersionMutableLiveData = MutableLiveData<Version>()    //当fragment的appbar滑动时调用了此方法 ，这里应该改变BottomNavigationView的位置    fun onAppBarOffsetChanged(verticalOffset: Int, appbarHeight: Float) {        appBarOffsetBias.value = verticalOffset.absoluteValue.toFloat() / appbarHeight    }    fun checkUnSubmitReceiptByTimer() {        Observable.interval(10, TimeUnit.SECONDS)            .flatMap { _ ->                // 每次定时触发时，重新获取未上传的小票列表（避免内存中旧数据问题）                Observable.fromIterable(SharedPrefModel.getUserModel().unSubmitReceiptList)                    .doOnSubscribe {                        Timber.d("\n")                        Timber.d("\n")                        Timber.d("------------------一轮定时小票检测START-----------------")                    }                    .flatMapSingle { receipt ->                        Timber.d("小票检测: 检测到未上传的小票 $receipt")                        financeService.submitReceipt(receipt)                            .onErrorResumeNext { error ->                                // 忽略错误，返回一个空的Single（不终止流）                                Timber.e("小票检测: 小票上传失败（已忽略）: $error")                                Single.never() // 或 Single.just(ErrorResult(error)) 如需记录错误                            }                            .doOnSuccess {                                Timber.e("小票检测: 小票上传成功")                                SharedPrefModel.removeUnSubmitReceipt(receipt)                            }                    }                    .toList() // 合并当次轮询的所有结果                    .toObservable() // 转回Observable以继续流            }            .switchThread() // 切换线程（需自定义）            .doOnNext { resultList ->                if (resultList.isNotEmpty()) {                    Timber.d("小票检测: 本轮上传成功 ${resultList.size} 张小票")                }            }            .bindLife() // 绑定生命周期（需自定义）    }    /*    //检查更新        fun checkUpdate() {            apiService.fetchVersions()                .switchThread()                .autoProgressDialog()                .catchApiError()                .doOnSuccess {                    latestVersionMutableLiveData.postValue(it[0])                }.bindLife()        }*/}